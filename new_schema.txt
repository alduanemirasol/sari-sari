================================================================================
  IMPROVED POS & MANAGEMENT SYSTEM SCHEMA (Multi-User + RBAC)
  Builds on previous single-user schema.
  Changes/additions marked with [NEW] or [CHANGED]
================================================================================

--------------------------------------------------------------------------------
LOOKUP / REFERENCE TABLES
--------------------------------------------------------------------------------

product_categories:
  id
  name                        e.g. Snacks, Beverages, Household

expense_categories:
  id
  name                        e.g. Utilities, Supplies, Salary

payment_types:
  id
  name                        e.g. cash, credit, gcash, bank_transfer

sale_types:
  id
  name                        e.g. retail, wholesale

units:
  id
  name                        e.g. liter, piece, kilogram
  abbreviation                e.g. L, pc, kg

unit_conversions:
  id
  product_id                  FK to products.id
  from_unit_id                FK to units.id
  to_unit_id                  FK to units.id
  factor                      Multiply to convert. e.g. 1L → 1000ml, factor = 1000

stock_log_reasons:
  id
  name                        e.g. restocked, sold, damaged, expired, adjustment, returned

sale_statuses:
  id
  name                        e.g. completed, voided, held

return_reasons:
  id
  name                        e.g. defective, wrong_item, customer_changed_mind, expired

--------------------------------------------------------------------------------
AUTHENTICATION & USERS  [NEW SECTION]
--------------------------------------------------------------------------------

[NEW] roles:
  id
  name                        e.g. owner, manager, cashier, inventory_clerk, viewer
  description                 Short explanation of what this role can do
  is_active                   Soft delete
  created_at
  updated_at

  -- Seed roles (suggested defaults):
  --   1  owner             Full access. Can manage users, roles, financials, everything.
  --   2  manager           Access to reports, inventory, sales. Cannot manage users/roles.
  --   3  cashier           POS sales only. No access to financial reports or settings.
  --   4  inventory_clerk   Manage stock, batches, and products. No sales or financials.
  --   5  viewer            Read-only access to reports and inventory.

[NEW] permissions:
  id
  module                      e.g. sales, inventory, reports, customers, expenses, users, settings
  action                      e.g. view, create, edit, delete, void, apply_discount
  name                        Human-readable. e.g. "View Sales Report"
  description

  -- Full permission list (suggested):
  --
  -- SALES
  --   sales.view             View sales history and receipts
  --   sales.create           Process new transactions at POS
  --   sales.void             Void a completed sale
  --   sales.apply_discount   Apply manual discounts during checkout
  --   sales.hold             Park / hold a transaction
  --
  -- INVENTORY
  --   inventory.view         View stock levels and batches
  --   inventory.create       Receive new stock batches
  --   inventory.edit         Edit product details and pricing
  --   inventory.adjust       Manual stock adjustments
  --   inventory.delete       Deactivate products
  --
  -- CUSTOMERS
  --   customers.view         View customer list and credit info
  --   customers.create       Add new customers
  --   customers.edit         Edit customer details
  --   customers.delete       Soft-delete customers
  --   customers.credit       Record and manage credit transactions
  --
  -- EXPENSES
  --   expenses.view          View expense records
  --   expenses.create        Log new expenses
  --   expenses.edit          Edit existing expenses
  --   expenses.delete        Delete expense records
  --
  -- REPORTS
  --   reports.sales          Access sales reports and summaries
  --   reports.inventory      Access inventory reports
  --   reports.financial      Access profit/loss and cash flow reports
  --   reports.credit         Access credit and receivables reports
  --   reports.audit          Access audit logs and user activity
  --
  -- USERS & ROLES
  --   users.view             View user accounts
  --   users.create           Add new user accounts
  --   users.edit             Edit user details and reset passwords
  --   users.delete           Deactivate user accounts
  --   roles.manage           Create, edit, and assign roles and permissions
  --
  -- SESSIONS
  --   sessions.open          Open a POS shift
  --   sessions.close         Close a POS shift
  --   sessions.view_others   View sessions opened by other users
  --
  -- SETTINGS
  --   settings.manage        Access and edit system configuration

[NEW] role_permissions:
  id
  role_id                     FK to roles.id
  permission_id               FK to permissions.id
  -- Junction table. Defines which permissions each role has.
  -- UNIQUE constraint on (role_id, permission_id)

[NEW] users:
  id
  role_id                     FK to roles.id
  first_name
  last_name
  username                    Unique. Used for login.
  email                       Unique. Optional but recommended for recovery.
  password_hash               Hashed password (bcrypt / argon2). Never store plaintext.
  pin_hash                    [OPTIONAL] Hashed short PIN for quick POS re-auth / lock screen
  is_active                   Soft delete. false = account disabled, cannot log in.
  must_change_password        Boolean. Force password reset on first login or after admin reset.
  last_login_at               Track last successful login timestamp.
  created_by                  FK to users.id — which user created this account
  created_at
  updated_at

[NEW] user_sessions:
  id
  user_id                     FK to users.id
  token_hash                  Hashed session token or JWT identifier
  ip_address                  Optional. Useful for audit trail.
  device_info                 Optional. Browser/device string.
  created_at                  Login time
  expires_at                  Token expiry
  revoked_at                  NULL = active. Set to revoke/logout.

  -- On login:  insert a new row with a generated token, return token to client.
  -- On logout: set revoked_at = NOW().
  -- On request: validate token exists, is not revoked, and not expired.

[NEW] password_reset_tokens:
  id
  user_id                     FK to users.id
  token_hash                  Hashed one-time reset token
  expires_at
  used_at                     NULL = not yet used. Set on use to prevent reuse.
  created_at

--------------------------------------------------------------------------------
AUDIT LOG  [NEW SECTION]
--------------------------------------------------------------------------------

[NEW] audit_logs:
  id
  user_id                     FK to users.id — who performed the action (nullable for system)
  action                      e.g. created, updated, deleted, voided, login, logout, failed_login
  module                      e.g. sales, inventory, users, settings
  record_id                   ID of the affected record (nullable)
  old_value                   JSON snapshot of record before change (nullable)
  new_value                   JSON snapshot of record after change (nullable)
  ip_address
  notes
  created_at

  -- Recommended actions to log:
  --   All logins (success and failure)
  --   Logouts and session revocations
  --   Sale voids and discounts
  --   Price changes
  --   Stock adjustments
  --   User account changes (create, edit, deactivate)
  --   Role/permission changes

--------------------------------------------------------------------------------
SESSIONS / SHIFTS  [CHANGED — now tied to a user]
--------------------------------------------------------------------------------

sessions:
  id
  user_id                     [NEW] FK to users.id — who opened the shift
  opened_at
  closed_at                   NULL while session is open
  opening_cash
  closing_cash
  notes
  created_at

session_cash_movements:
  id
  session_id                  FK to sessions.id
  user_id                     [NEW] FK to users.id — who recorded the movement
  movement_type               e.g. cash_in, cash_out
  amount
  notes
  created_at

--------------------------------------------------------------------------------
PRODUCTS
--------------------------------------------------------------------------------

products:
  id
  name
  unit_id                     FK to units.id
  product_category_id         FK to product_categories.id
  stock_quantity
  image_url
  is_active
  created_by                  [NEW] FK to users.id
  updated_by                  [NEW] FK to users.id
  created_at
  updated_at

product_pricing:
  id
  product_id                  FK to products.id
  unit_id                     FK to units.id
  label
  retail_price
  wholesale_price
  wholesale_min_qty
  effective_date
  created_by                  [NEW] FK to users.id — who set this price

--------------------------------------------------------------------------------
BUNDLES
--------------------------------------------------------------------------------

bundles:
  id
  bundle_name
  bundle_price
  is_active
  created_by                  [NEW] FK to users.id
  created_at
  updated_at

bundle_items:
  id
  bundle_id                   FK to bundles.id
  product_id                  FK to products.id
  unit_id                     FK to units.id
  quantity

--------------------------------------------------------------------------------
STOCK
--------------------------------------------------------------------------------

stock_batches:
  id
  product_id                  FK to products.id
  unit_id                     FK to units.id
  quantity_received
  expiration_date
  notes
  received_by                 [NEW] FK to users.id
  created_at
  updated_at

stock_logs:
  id
  product_id                  FK to products.id
  unit_id                     FK to units.id
  stock_batch_id              FK to stock_batches.id (nullable)
  stock_log_reason_id         FK to stock_log_reasons.id
  performed_by                [NEW] FK to users.id — who made the change
  change_qty
  notes
  created_at

--------------------------------------------------------------------------------
CUSTOMERS
--------------------------------------------------------------------------------

customers:
  id
  first_name
  middle_name
  last_name
  contact_number
  municipality
  barangay
  street
  credit_limit
  is_active
  created_by                  [NEW] FK to users.id
  updated_by                  [NEW] FK to users.id
  created_at
  updated_at

--------------------------------------------------------------------------------
SALES
--------------------------------------------------------------------------------

sales:
  id
  session_id                  FK to sessions.id
  cashier_id                  [NEW] FK to users.id — who processed the transaction
  customer_id                 FK to customers.id (nullable for walk-in)
  payment_type_id             FK to payment_types.id
  sale_status_id              FK to sale_statuses.id
  voided_by                   [NEW] FK to users.id (nullable — set when voided)
  voided_at                   [NEW] Timestamp of void
  void_reason                 [NEW] Short explanation required when voiding
  sale_date
  subtotal
  discount
  discount_approved_by        [NEW] FK to users.id — manager approval for large discounts
  total_amount
  notes
  created_at

sale_items:
  id
  sale_id                     FK to sales.id
  product_id                  FK to products.id
  unit_id                     FK to units.id
  sale_type_id                FK to sale_types.id
  quantity_sold
  unit_price

sale_bundles:
  id
  sale_id                     FK to sales.id
  bundle_id                   FK to bundles.id
  quantity_sold
  unit_price

sale_bundle_items:
  id
  sale_bundle_id              FK to sale_bundles.id
  bundle_item_id              FK to bundle_items.id
  quantity_deducted

--------------------------------------------------------------------------------
RETURNS & REFUNDS
--------------------------------------------------------------------------------

sale_returns:
  id
  original_sale_id            FK to sales.id
  processed_by                [NEW] FK to users.id — who processed the return
  approved_by                 [NEW] FK to users.id — manager who approved (nullable)
  return_reason_id            FK to return_reasons.id
  return_date
  total_refund_amount
  notes
  created_at

sale_return_items:
  id
  sale_return_id              FK to sale_returns.id
  sale_item_id                FK to sale_items.id
  quantity_returned
  refund_amount
  restock                     Boolean

--------------------------------------------------------------------------------
CREDIT
--------------------------------------------------------------------------------

credit_transactions:
  id
  customer_id                 FK to customers.id
  sale_id                     FK to sales.id
  created_by                  [NEW] FK to users.id
  amount_owed
  amount_paid
  remaining_balance
  due_date
  is_settled
  created_at

credit_payments:
  id
  credit_transaction_id       FK to credit_transactions.id
  received_by                 [NEW] FK to users.id — who collected the payment
  amount_paid
  paid_at
  notes

--------------------------------------------------------------------------------
EXPENSES
--------------------------------------------------------------------------------

expenses:
  id
  expense_category_id         FK to expense_categories.id
  session_id                  FK to sessions.id (nullable)
  recorded_by                 [NEW] FK to users.id
  approved_by                 [NEW] FK to users.id (nullable — for larger expenses)
  amount
  notes
  image_url
  expense_date
  created_at

================================================================================
ROLE → PERMISSION MATRIX (Suggested Defaults)
================================================================================

  Permission                  owner   manager  cashier  inv_clerk  viewer
  --------------------------  ------  -------  -------  ---------  ------
  sales.view                    ✓       ✓        ✓         -          ✓
  sales.create                  ✓       ✓        ✓         -          -
  sales.void                    ✓       ✓        -         -          -
  sales.apply_discount          ✓       ✓        -         -          -
  sales.hold                    ✓       ✓        ✓         -          -
  inventory.view                ✓       ✓        -         ✓          ✓
  inventory.create              ✓       ✓        -         ✓          -
  inventory.edit                ✓       ✓        -         ✓          -
  inventory.adjust              ✓       ✓        -         ✓          -
  inventory.delete              ✓       -        -         -          -
  customers.view                ✓       ✓        ✓         -          ✓
  customers.create              ✓       ✓        ✓         -          -
  customers.edit                ✓       ✓        -         -          -
  customers.delete              ✓       -        -         -          -
  customers.credit              ✓       ✓        ✓         -          -
  expenses.view                 ✓       ✓        -         -          ✓
  expenses.create               ✓       ✓        -         -          -
  expenses.edit                 ✓       ✓        -         -          -
  expenses.delete               ✓       -        -         -          -
  reports.sales                 ✓       ✓        -         -          ✓
  reports.inventory             ✓       ✓        -         ✓          ✓
  reports.financial             ✓       ✓        -         -          -
  reports.credit                ✓       ✓        -         -          ✓
  reports.audit                 ✓       -        -         -          -
  users.view                    ✓       ✓        -         -          -
  users.create                  ✓       -        -         -          -
  users.edit                    ✓       -        -         -          -
  users.delete                  ✓       -        -         -          -
  roles.manage                  ✓       -        -         -          -
  sessions.open                 ✓       ✓        ✓         -          -
  sessions.close                ✓       ✓        ✓         -          -
  sessions.view_others          ✓       ✓        -         -          -
  settings.manage               ✓       -        -         -          -

================================================================================
NOTES ON KEY DESIGN DECISIONS
================================================================================

1. AUTHENTICATION FLOW
   - User submits username + password.
   - App verifies password_hash using bcrypt/argon2.
   - On success: insert into user_sessions, return session token to client.
   - Each request: client sends token → app looks up user_sessions, joins users
     and roles, checks is_active, checks expiry, loads permissions.
   - On logout: set user_sessions.revoked_at = NOW().
   - Failed logins should be recorded in audit_logs to detect brute force attempts.

2. PERMISSION CHECKING
   - At runtime, load the user's role → fetch all permissions via role_permissions.
   - Cache permissions per session to avoid repeated DB lookups.
   - For sensitive actions (void, large discount, return approval), check both
     the permission AND optionally require a secondary auth (re-enter PIN).

3. PIN RE-AUTH (OPTIONAL)
   - users.pin_hash enables a quick lock screen at the POS without full logout.
   - Cashier steps away → POS locks → next user enters PIN to unlock or switch user.
   - Useful for shared terminals.

4. APPROVAL WORKFLOWS
   - sales.discount_approved_by: if discount exceeds a threshold, cashier must
     call manager who enters their credentials to approve.
   - sale_returns.approved_by: returns above a threshold require manager sign-off.
   - expenses.approved_by: large expenses can require owner/manager approval.
   - These fields are nullable — only populated when approval was needed.

5. AUDIT LOG STRATEGY
   - Log every write operation (insert/update/delete) on sensitive tables.
   - Store old_value and new_value as JSON for full changesets.
   - Never delete audit_log rows. This is your tamper evidence trail.
   - Only users with reports.audit permission can view audit logs.

6. SOFT DELETES ON USERS
   - Never hard delete a user account. Set is_active = false.
   - Past sales, stock logs, and audit trails reference user IDs — deleting breaks history.
   - Revoke all active user_sessions when deactivating an account.

7. STOCK SOURCE OF TRUTH
   - products.stock_quantity is denormalized for fast POS reads.
   - Always update it atomically alongside stock_logs inserts.
   - stock_logs.performed_by identifies who made each inventory change.

8. PRICE HISTORY
   - product_pricing uses effective_date rows rather than overwriting prices.
   - product_pricing.created_by tracks who changed the price and when.

9. SESSION / SHIFT RECONCILIATION
   - sessions.user_id tracks who opened and is responsible for the shift.
   - All sales in a session are filterable by sessions.user_id for per-cashier reports.
   - Cash variance = closing_cash - (opening_cash + cash_in - cash_out + completed sale totals).

================================================================================